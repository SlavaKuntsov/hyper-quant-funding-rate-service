# Содержание
1. [Инициализация и восстановление системы](#1-инициализация-и-восстановление-системы)
2. [Первый запуск системы](#11-первый-запуск-системы)
3. [Восстановление после сбоя](#12-восстановление-после-сбоя)
4. [Работа со ставками финансирования](#2-работа-со-ставками-финансирования)
5. [Администратор получает список последней истории ставок финансирования](#21-администратор-получает-историю-ставок-финансирования)
6. [Администратор получает актуальные ставки финансирования](#22-администратор-получает-актуальные-ставки-финансирования)

---    
## 1. Инициализация и восстановление системы

### 1.1. Первый запуск системы

**Актор:** Система

**Предусловия:**
- Первоначальная установка системы
- База данных не инициализирована

**Основной поток:**
1. Система инициализирует схему базы данных
2. Система автоматически добавляет поддерживаемые биржи: Binance, Bybit, HyperLiquid и Mexc
3. При обнаружении некорректной конфигурации, система регистрирует соответствующие предупреждения в лог
4. Система блокирует выполнение других фоновых задач пока не будет выполнено поулчение всех исторических данных
5. Запуск полной исторической синхронизации
  - Система вызывает BaseFundingRateHistoryService.UpdateHistoricalFundingsAsync() для каждой биржи
  - Для каждой биржи выполняется ExecuteFullHistoricalSync():
    - Получение списка всех торговых символов через FetchSymbolsAsync()
    - Определение даты листинга каждого символа
    - Загрузка исторических данных с момента листинга
  - Процесс выполняется параллельно для всех бирж с контролем нагрузки через семафоры
6. Система использует BulkInsertAsync() для эффективного сохранения больших объемов данных
7. Логирование результатов и переход в рабочий режим
8. Система начинает функционировать в стандартном режиме

**Результат:**
- Система успешно инициализирована с базовой конфигурацией
- Администратор информирован о потенциальных проблемах с конфигурацией через логи системы
- Система успешно инициализирована с полными историческими данными
- Система готова к обработке API запросов от администратора и следующих фоновых задач

---   
### 1.2. Восстановление после сбоя

**Актор:** Система/Администратор

**Предусловия:**
- Система была ранее инициализирована и настроена
- Произошел сбой в работе системы
- База данных содержит исторические данные и сохранила целостность
- Конфигурация системы не изменилась

**Основной поток:**
1. Администратор инициирует перезапуск системы
2. Система восстанавливает подключение к базе данных
3. Система выполняет проверку работоспособности основных компонентов
4. При следующем запланированном выполнении фоновой задачи, система актуализирует информацию о записях
5. Если пропущен большой период времени, заполняет пропущенные пробелы данных
6. Система возобновляет стандартное функционирование

**Альтернативный поток:**
- При невозможности подключения к базе данных:
  1. Система регистрирует критическую ошибку в лог
  2. Процесс восстановления прерывается

**Результат:**
- Система возобновляет работу в стандартном режиме
- Информация о записях актуализируется при следующем выполнении фоновой задачи
- Система продолжает выполнение запланированных задач

---    
## 2. Работа с историческими ставками финансирования

### 2.1. Администратор обновляет исторические данные
**Актор:** Администратор

**Предусловия:**
- Система функционирует в рабочем режиме

**Основной поток:**
1. Администратор выполняет HTTP POST запрос `/api/v1/funding-history/{exchangeName}`
   ![Image](images/Pasted%20image%2020250601142006.png)
2. Система проверяет символы которые нуждаются в обновлении ставки финансирования и есть ли пропущенные интервалы обновления
3. Выполнение инкрементальной синхронизации:
  - Если обновление не требуется переходим к следующему символу
  - Если пропущен только 1 интервал - делаем обновление
  - Если есть промежутки в истории, то система запрашивает историю за пропущенный промежуток
  - Если символ не найден в базе данных, то система получает всю историю ставок финансирования для этого символа
4. Сохранение обновленных данных в базу
5. Система возвращает число добавленных/обновленных записей

**Результат:**
- База данных обновлена новейшими историческими записями для символов
- Администратор получает количество обновленных записей
- Пропуски в исторических данных заполнены

---
### 2.2. Администратор получает последние ставки из истории для биржи

**Актор:** Администратор

**Предусловия:**
- Система функционирует в рабочем режиме
- В базе данных есть исторические данные

**Основной поток:**
1. Администратор выполняет HTTP GET запрос `/api/v1/funding-history/{exchangeName}/latest`, указывая номер страницы и размер (эндпоинт поддерживает пагинацию)
   ![Image](images/Pasted%20image%2020250601142213.png)
2. Система извлекает последние ставки финансирования для указанной биржи из истории
3. Система возвращает пагинированный список ставок финансирования
   ![Image](images/Pasted%20image%2020250601142410.png)

**Результат:**
- Администратор получает пагинированный список последних исторических ставок для выбранной биржи
- Каждая запись содержит информацию о символе, ставке и времени

---

### 2.3. Администратор получает историю ставок для символа

**Актор:** Администратор

**Предусловия:**
- Система функционирует в рабочем режиме
- В базе данных есть исторические данные для запрашиваемого символа

**Основной поток:**
1. Администратор выполняет HTTP GET запрос `/api/v1/funding-history/{exchangeName}/symbol/{symbol}/history`, указывая номер страницы и размер (эндпоинт поддерживает пагинацию)
   ![Image](images/Pasted%20image%2020250601142518.png)
2. Система извлекает историческую информацию для указанного символа на указанной бирже
3. Данные сортируются по времени в обратном порядке (от новых к старым)
4. Система возвращает пагинированный список исторических ставок
   ![Image](images/Pasted%20image%2020250601142550.png)

**Альтернативный поток:**
- Если символ не найден на указанной бирже:
  1. Система возвращает статус 404 Not Found
  2. В ответе указывается, что символ не найден

**Результат:**
- Администратор получает полную историю ставок финансирования для конкретного символа
- История отсортирована по времени для удобства анализа

---

### 2.4. Администратор получает последние ставки для всех символов

**Актор:** Администратор

**Предусловия:**
- Система функционирует в рабочем режиме
- В базе данных есть исторические данные

**Основной поток:**
1. Администратор выполняет HTTP GET запрос `/api/v1/funding-history/latest`, указывая номер страницы и размер (эндпоинт поддерживает пагинацию)
   ![Image](images/Pasted%20image%2020250601142605.png)
2. Система извлекает последние ставки для всех символов, группируя их по символам
3. Для каждого символа собираются ставки со всех бирж
4. Система возвращает пагинированный список сгруппированных ставок
   ![Image](images/Pasted%20image%2020250601143243.png)

**Результат:**
- Администратор получает сводную информацию о последних ставках по всем символам
- Данные сгруппированы по символам для удобства сравнения между биржами

---
## 3. Работа с актуальными ставками финансирования

### 3.1. Администратор обновляет актуальные ставки

**Актор:** Администратор

**Предусловия:**
- Система функционирует в рабочем режиме
- Есть подключение к API бирж

**Основной поток:**
1. Администратор выполняет HTTP POST запрос `/api/v1/funding-online/{exchangeName}`
   ![Image](images/Pasted%20image%2020250601143323.png)
2. Система подключается к API выбранной биржи
3. Система запрашивает текущие ставки финансирования для всех активных символов
4. Для каждого полученного символа обновляет данные в бд
5. Сохранение обновленных данных в базу
6. Система возвращает число обновленных/созданных записей

**Альтернативный поток:**
- При недоступности API биржи:
  1. Система регистрирует ошибку в лог
  2. Возвращает информацию об ошибке администратору

**Результат:**
- База данных обновлена актуальными ставками финансирования
- Администратор получает количество обновленных записей
---
### 3.2. Администратор получает ставки для конкретной биржи

**Актор:** Администратор

**Предусловия:**
- Система функционирует в рабочем режиме
- В базе данных есть актуальные данные

**Основной поток:**
1. Администратор выполняет HTTP GET запрос `/api/v1/funding-online/{exchangeName}`, указывая номер страницы и размер (эндпоинт поддерживает пагинацию)
   ![Image](images/Pasted%20image%2020250601143416.png)
2. Система извлекает актуальные ставки финансирования для указанной биржи
3. Данные сортируются по символам
4. Система возвращает пагинированный список ставок
   ![Image](images/Pasted%20image%2020250601143447.png)

**Результат:**
- Администратор получает список актуальных ставок для выбранной биржи
- Данные представлены в удобном для анализа формате
---
### 3.3. Администратор получает последние ставки всех бирж

**Актор:** Администратор

**Предусловия:**
- Система функционирует в рабочем режиме
- В базе данных есть актуальные данные

**Основной поток:**
1. Администратор выполняет HTTP GET запрос `/api/v1/funding-online`, указывая номер страницы и размер (эндпоинт поддерживает пагинацию)
   ![Image](images/Pasted%20image%2020250601143504.png)
2. Система извлекает последние ставки финансирования для всех символов со всех бирж
3. Данные группируются по символам
4. Для каждого символа собираются ставки со всех бирж где он торгуется
5. Система возвращает пагинированный список сгруппированных ставок
   ![Image](images/Pasted%20image%2020250601143527.png)

**Результат:**
- Администратор получает сводную информацию о текущих ставках по всем биржам
- Данные позволяют быстро сравнить ставки между биржами для арбитражных возможностей